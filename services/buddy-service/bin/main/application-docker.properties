# Buddy Service - Docker Production Configuration
# Configuration for Docker containerized environments

# ============================================================================
# SERVER CONFIGURATION - Ultra-Optimized for Production
# ============================================================================
server.port=8087
spring.application.name=buddy-service

# Graceful shutdown with proper timeout
server.shutdown=graceful
spring.lifecycle.timeout-per-shutdown-phase=90s

# Thread pool configuration optimized for containers
server.tomcat.threads.max=100
server.tomcat.threads.min-spare=5
server.tomcat.max-connections=2000
server.tomcat.accept-count=50
server.tomcat.connection-timeout=30000
server.tomcat.keep-alive-timeout=60000
server.tomcat.max-keep-alive-requests=100

# ============================================================================
# DATABASE CONFIGURATION
# ============================================================================
# PostgreSQL Database (will be overridden by environment variables)
spring.datasource.url=${SPRING_DATASOURCE_URL:jdbc:postgresql://buddy-postgres:5432/buddy_service}
spring.datasource.username=${SPRING_DATASOURCE_USERNAME:buddy_user}
spring.datasource.password=${SPRING_DATASOURCE_PASSWORD:buddy_password}
spring.datasource.driver-class-name=org.postgresql.Driver

# Connection Pool Configuration (optimized for containers)
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.max-lifetime=1200000
spring.datasource.hikari.connection-timeout=15000
spring.datasource.hikari.leak-detection-threshold=30000
spring.datasource.hikari.pool-name=BuddyServiceCP
spring.datasource.hikari.allow-pool-suspension=true
spring.datasource.hikari.auto-commit=false

# ============================================================================
# JPA/HIBERNATE CONFIGURATION
# ============================================================================
spring.jpa.hibernate.ddl-auto=none
spring.jpa.show-sql=false
spring.jpa.properties.hibernate.format_sql=false
spring.jpa.properties.hibernate.jdbc.batch_size=50
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true
spring.jpa.properties.hibernate.jdbc.batch_versioned_data=true
spring.jpa.properties.hibernate.connection.provider_disables_autocommit=true
spring.jpa.properties.hibernate.cache.use_second_level_cache=false
spring.jpa.properties.hibernate.query.fail_on_pagination_over_collection_fetch=true

# ============================================================================
# FLYWAY CONFIGURATION
# ============================================================================
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true
spring.flyway.validate-on-migrate=true
spring.flyway.clean-disabled=true
spring.flyway.url=${SPRING_FLYWAY_URL:jdbc:postgresql://buddy-postgres:5432/buddy_service}
spring.flyway.user=${SPRING_FLYWAY_USER:buddy_user}
spring.flyway.password=${SPRING_FLYWAY_PASSWORD:buddy_password}

# ============================================================================
# REDIS CONFIGURATION
# ============================================================================
spring.data.redis.host=${SPRING_DATA_REDIS_HOST:buddy-redis}
spring.data.redis.port=${SPRING_DATA_REDIS_PORT:6379}
spring.data.redis.password=${SPRING_DATA_REDIS_PASSWORD:redis_password}
spring.data.redis.timeout=5000ms
spring.data.redis.database=${SPRING_DATA_REDIS_DATABASE:7}

# Redis Connection Pool (container optimized)
spring.data.redis.jedis.pool.max-active=10
spring.data.redis.jedis.pool.max-idle=5
spring.data.redis.jedis.pool.min-idle=2
spring.data.redis.jedis.pool.max-wait=2000ms

# ============================================================================
# CACHE CONFIGURATION
# ============================================================================
spring.cache.type=redis
spring.cache.redis.time-to-live=3600000
spring.cache.redis.cache-null-values=false
spring.cache.redis.use-key-prefix=true
spring.cache.redis.key-prefix=buddy:

# ============================================================================
# JWT CONFIGURATION
# ============================================================================
jwt.secret=${JWT_SECRET:your-secret-key-must-be-changed-in-production}
jwt.expiration=${JWT_EXPIRATION:86400}

# ============================================================================
# SERVICE URLS
# ============================================================================
identity-service.url=${IDENTITY_SERVICE_URL:http://identity-service:8081}
backend-service.url=${BACKEND_SERVICE_URL:http://focushive-backend:8080}
notification-service.url=${NOTIFICATION_SERVICE_URL:http://notification-service:8083}
chat-service.url=${CHAT_SERVICE_URL:http://chat-service:8084}
analytics-service.url=${ANALYTICS_SERVICE_URL:http://analytics-service:8085}

# ============================================================================
# BUDDY MATCHING CONFIGURATION
# ============================================================================
# Matching Algorithm Settings
buddy.matching.max-suggestions=${BUDDY_MATCHING_MAX_SUGGESTIONS:10}
buddy.matching.compatibility-threshold=${BUDDY_MATCHING_COMPATIBILITY_THRESHOLD:0.6}
buddy.matching.queue-size=${BUDDY_MATCHING_QUEUE_SIZE:100}
buddy.matching.interval-ms=300000

# Matching Weights (must sum to 1.0)
buddy.matching.weights.timezone=0.25
buddy.matching.weights.interests=0.20
buddy.matching.weights.goals=0.20
buddy.matching.weights.activity=0.15
buddy.matching.weights.communication=0.10
buddy.matching.weights.personality=0.10

# ============================================================================
# PARTNERSHIP CONFIGURATION
# ============================================================================
buddy.partnership.max-per-user=${BUDDY_PARTNERSHIP_MAX_PER_USER:3}
buddy.partnership.min-duration-days=7
buddy.partnership.default-duration-days=30
buddy.partnership.health-check-interval-ms=86400000

# ============================================================================
# CHECK-IN CONFIGURATION
# ============================================================================
buddy.checkin.reminder-hour=${BUDDY_CHECKIN_REMINDER_HOUR:20}
buddy.checkin.grace-period-hours=24
buddy.checkin.streak-break-threshold-days=2
buddy.checkin.min-rate-for-good-standing=0.7

# ============================================================================
# ACCOUNTABILITY CONFIGURATION
# ============================================================================
buddy.accountability.calculation-interval-ms=3600000
buddy.accountability.min-score-for-matching=50.0
buddy.accountability.streak-bonus-multiplier=1.2

# ============================================================================
# NOTIFICATION CONFIGURATION
# ============================================================================
buddy.notifications.enabled=${BUDDY_NOTIFICATIONS_ENABLED:true}
buddy.notifications.reminder-enabled=true
buddy.notifications.celebration-enabled=true
buddy.notifications.nudge-enabled=true

# ============================================================================
# SCHEDULER CONFIGURATION
# ============================================================================
buddy.scheduler.enabled=${BUDDY_SCHEDULER_ENABLED:true}
buddy.scheduler.matching-cron=0 */5 * * * *
buddy.scheduler.health-check-cron=0 0 2 * * *
buddy.scheduler.reminder-cron=0 0 ${buddy.checkin.reminder-hour} * * *
buddy.scheduler.cleanup-cron=0 0 1 * * *

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================
logging.level.com.focushive.buddy=${LOGGING_LEVEL_COM_FOCUSHIVE_BUDDY:INFO}
logging.level.org.springframework.web=${LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_WEB:WARN}
logging.level.org.springframework.security=WARN
logging.level.org.hibernate.SQL=WARN
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=WARN
logging.level.org.flywaydb=INFO
logging.level.redis.clients.jedis=WARN

# File logging configuration
logging.file.name=${LOGGING_FILE_NAME:logs/buddy-service.log}
logging.logback.rollingpolicy.max-file-size=50MB
logging.logback.rollingpolicy.total-size-cap=1GB
logging.logback.rollingpolicy.max-history=30
logging.logback.rollingpolicy.clean-history-on-start=true

# Async logging for performance
# logging.config=classpath:logback-spring.xml

# ============================================================================
# ACTUATOR CONFIGURATION
# ============================================================================
management.endpoints.web.exposure.include=${MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE:health,info,metrics,prometheus}
management.endpoint.health.show-details=${MANAGEMENT_ENDPOINT_HEALTH_SHOW_DETAILS:when-authorized}
management.endpoint.health.show-components=always
management.info.env.enabled=true

# Metrics and monitoring
management.metrics.export.prometheus.enabled=true
management.metrics.distribution.percentiles-histogram.http.server.requests=true
management.metrics.distribution.slo.http.server.requests=50ms,100ms,200ms,300ms,500ms,1s
management.metrics.cache.instrument=true
management.metrics.cache.enabled=true

# Custom health indicators
management.health.redis.enabled=true
management.health.db.enabled=true
management.health.diskspace.enabled=true

# ============================================================================
# JACKSON JSON CONFIGURATION
# ============================================================================
spring.jackson.serialization.write-dates-as-timestamps=false
spring.jackson.serialization.indent-output=false
spring.jackson.deserialization.fail-on-unknown-properties=false
spring.jackson.default-property-inclusion=NON_NULL

# ============================================================================
# VALIDATION CONFIGURATION
# ============================================================================
spring.validation.use-spring-boot-defaults=true

# ============================================================================
# API DOCUMENTATION CONFIGURATION
# ============================================================================
springdoc.api-docs.path=/v3/api-docs
springdoc.swagger-ui.path=/swagger-ui.html
springdoc.swagger-ui.enabled=true
springdoc.swagger-ui.operationsSorter=method
springdoc.swagger-ui.tags-sorter=alpha
springdoc.swagger-ui.try-it-out-enabled=true
springdoc.swagger-ui.disable-swagger-default-url=true

# ============================================================================
# SECURITY CONFIGURATION
# ============================================================================
# Security headers
server.servlet.session.cookie.secure=true
server.servlet.session.cookie.http-only=true
server.servlet.session.cookie.same-site=strict

# ============================================================================
# PERFORMANCE CONFIGURATION
# ============================================================================
# HTTP/2 support
server.http2.enabled=true

# Compression
server.compression.enabled=true
server.compression.mime-types=text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
server.compression.min-response-size=1024

# ============================================================================
# PROFILE CONFIGURATION
# ============================================================================
# This configuration is for docker profile

# SQL script data initialization
spring.sql.init.mode=never

# Disable development features
spring.devtools.restart.enabled=false
spring.devtools.livereload.enabled=false

# Production optimizations
spring.main.lazy-initialization=${SPRING_MAIN_LAZY_INITIALIZATION:false}
spring.jpa.open-in-view=${SPRING_JPA_OPEN_IN_VIEW:true}
spring.jmx.enabled=${SPRING_JMX_ENABLED:true}

# Enable debug logs for troubleshooting (should be false in production)
debug=false

# ============================================================================
# CONTAINER OPTIMIZATIONS
# ============================================================================
# Fast startup and graceful shutdown optimizations
spring.lifecycle.timeout-per-shutdown-phase=90s
management.endpoint.shutdown.enabled=true
management.endpoints.web.exposure.include=${MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE:health,info,shutdown}

# JVM and memory optimizations
spring.jpa.properties.hibernate.jdbc.time_zone=UTC
spring.jackson.serialization.write-dates-as-timestamps=false

# Network optimizations
server.tomcat.processor-cache=200
server.tomcat.additional-tld-skip-patterns=*.jar
