server:
  port: 0  # Random port for tests

spring:
  application:
    name: api-gateway-test
  
  cloud:
    gateway:
      # Test CORS configuration
      globalcors:
        cors-configurations:
          '[/**]':
            allow-credentials: true
            allowed-origin-patterns: "*"
            allowed-headers: "*"
            allowed-methods:
              - GET
              - POST
              - PUT
              - DELETE
              - PATCH
              - OPTIONS
            exposed-headers:
              - Authorization
              - X-Rate-Limit-Remaining
              - X-Rate-Limit-Retry-After-Seconds
      
      # Service discovery disabled for tests
      discovery:
        locator:
          enabled: false
      
      # Test route definitions with mock services
      routes:
        # Identity Service routes
        - id: identity-service-test
          uri: http://httpbin.org  # Mock service for testing
          predicates:
            - Path=/auth/**, /oauth2/**, /userinfo, /profile/**, /personas/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
                redis-rate-limiter.requestedTokens: 1
            - StripPrefix=0
        
        # FocusHive Backend routes (protected)
        - id: focushive-backend-test
          uri: http://httpbin.org  # Mock service for testing
          predicates:
            - Path=/hives/**, /presence/**, /timers/**, /focus-sessions/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 200
                redis-rate-limiter.burstCapacity: 400
                redis-rate-limiter.requestedTokens: 1
            - JwtAuthenticationFilter
            - StripPrefix=0
        
        # Music Service routes (protected)
        - id: music-service-test
          uri: http://httpbin.org  # Mock service for testing
          predicates:
            - Path=/music/**, /playlists/**, /spotify/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 50
                redis-rate-limiter.burstCapacity: 100
                redis-rate-limiter.requestedTokens: 1
            - JwtAuthenticationFilter
            - StripPrefix=0
        
        # Health checks route (public)
        - id: health-checks-test
          uri: http://httpbin.org  # Mock service for testing
          predicates:
            - Path=/health/**, /actuator/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                redis-rate-limiter.requestedTokens: 1
            - StripPrefix=0
      
      # Default filters for tests
      default-filters:
        - name: GlobalFilter
        - name: Retry
          args:
            retries: 2
            methods: GET,POST,PUT,DELETE
            backoff:
              firstBackoff: 10ms
              maxBackoff: 100ms
  
  # Redis configuration for tests (will be overridden by TestContainers)
  data:
    redis:
      host: localhost
      port: 6379
      timeout: 1000ms
      connect-timeout: 1000ms
  
  # Security configuration for tests
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8081
  
  # Cache configuration for tests
  cache:
    type: redis
    redis:
      time-to-live: 60000  # 1 minute for tests

# Management endpoints for tests
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: always
  metrics:
    export:
      prometheus:
        enabled: false

# Circuit breaker configuration for tests
resilience4j:
  circuitbreaker:
    instances:
      identity-service-cb:
        sliding-window-size: 5
        minimum-number-of-calls: 3
        failure-rate-threshold: 50
        wait-duration-in-open-state: 1s
        permitted-number-of-calls-in-half-open-state: 2
      focushive-backend-cb:
        sliding-window-size: 5
        minimum-number-of-calls: 3
        failure-rate-threshold: 50
        wait-duration-in-open-state: 1s
        permitted-number-of-calls-in-half-open-state: 2

# Test-specific configuration
focushive:
  jwt:
    secret: your-256-bit-secret-key-here-make-it-secure-for-testing
    expiration: 3600000  # 1 hour

# Logging configuration for tests
logging:
  level:
    com.focushive.gateway: INFO
    org.springframework.cloud.gateway: WARN
    org.springframework.security: WARN
    org.springframework.web.reactive.function.client: WARN
    reactor.netty: WARN
    org.testcontainers: WARN
  pattern:
    console: "%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"