#!/bin/bash

# FocusHive Pre-push Hook
# This hook runs before pushing to remote and ensures all tests pass

set -e

echo "üöÄ FocusHive Pre-push Hook Running..."

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

print_error() {
    echo -e "${RED}‚ùå $1${NC}"
}

print_success() {
    echo -e "${GREEN}‚úÖ $1${NC}"
}

# Run all tests
echo "Running all tests before push..."

FAILED=0

# Frontend checks
if [ -d "frontend" ]; then
    cd frontend
    
    # Run linting
    echo "Running frontend linting..."
    if ! npm run lint; then
        print_error "Frontend linting failed"
        FAILED=1
    else
        print_success "Frontend linting passed"
    fi
    
    # Run build
    echo "Running frontend build..."
    if ! npm run build; then
        print_error "Frontend build failed"
        FAILED=1
    else
        print_success "Frontend build passed"
    fi
    
    # Run tests
    echo "Running frontend tests..."
    if ! npm test -- --run; then
        print_error "Frontend tests failed"
        FAILED=1
    else
        print_success "Frontend tests passed"
    fi
    
    cd ../..
fi

# Backend checks
if [ -d "backend" ]; then
    cd backend
    
    # Run build (includes compilation and tests)
    echo "Running backend build..."
    if ! ./gradlew build; then
        print_error "Backend build failed"
        FAILED=1
    else
        print_success "Backend build passed"
    fi
    
    cd ..
fi

# Identity Service checks
if [ -d "identity-service" ]; then
    cd identity-service
    
    # Run build (includes compilation and tests)
    echo "Running identity-service build..."
    if ! ./gradlew build; then
        print_error "Identity Service build failed"
        FAILED=1
    else
        print_success "Identity Service build passed"
    fi
    
    cd ..
fi

# Check for uncommitted changes
if ! git diff-index --quiet HEAD --; then
    print_error "You have uncommitted changes. Please commit or stash them."
    FAILED=1
fi

if [ $FAILED -eq 1 ]; then
    print_error "Pre-push checks failed! Push aborted."
    exit 1
else
    print_success "All pre-push checks passed!"
    exit 0
fi