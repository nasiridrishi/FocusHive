import React from 'react'
import {renderHook, waitFor} from '@testing-library/react'
import {QueryClient, QueryClientProvider} from '@tanstack/react-query'
import {describe, expect, it, vi, beforeEach} from 'vitest'
import {useHiveDetails} from '../useHiveQueries'
import * as authModule from '../useAuthQueries'
import type {User} from '@shared/types/auth'
import {hiveApiService} from '@services/api/hiveApi'
import {server} from '../../../test-utils/msw-server'
import {http, HttpResponse} from 'msw'

describe('useHiveQueries Authorization Tests', () => {
  let queryClient: QueryClient

  beforeEach(() => {
    queryClient = new QueryClient({
      defaultOptions: {
        queries: {
          retry: false,
          staleTime: 0,
          gcTime: 0
        },
        mutations: {retry: false}
      }
    })
    vi.clearAllMocks()
  })

  const wrapper = ({children}: {children: React.ReactNode}) => (
    <QueryClientProvider client={queryClient}>
      {children}
    </QueryClientProvider>
  )

  describe('isOwner check', () => {
    it('should return true when current user is the hive owner', async () => {
      const mockUser: User = {
        id: 'user-123',
        email: 'test@example.com',
        username: 'testuser',
        firstName: 'Test',
        lastName: 'User',
        name: 'Test User',
        isEmailVerified: true,
        createdAt: '2024-01-01T00:00:00Z',
        updatedAt: '2024-01-01T00:00:00Z'
      }

      // Mock the useAuth hook to return our test user
      vi.spyOn(authModule, 'useAuth').mockReturnValue({
        user: mockUser,
        isAuthenticated: true,
        isLoading: false,
        error: null,
        login: vi.fn(),
        logout: vi.fn(),
        register: vi.fn(),
        isLoggingIn: false,
        isLoggingOut: false,
        isRegistering: false,
        loginError: null,
        logoutError: null,
        registerError: null,
        refetchUser: vi.fn(),
        refetchAuthStatus: vi.fn(),
        isUserLoading: false,
        isAuthStatusLoading: false,
        userError: null,
        authStatusError: null
      })

      const mockHive = {
        id: 456,
        name: 'Test Hive',
        description: 'A test hive',
        ownerId: 'user-123', // Same as current user
        memberCount: 5,
        maxMembers: 10,
        isPrivate: false,
        createdAt: '2024-01-01T00:00:00Z'
      }

      // Setup MSW handlers for this test
      server.use(
        http.get('http://localhost:8080/api/v1/hives/:id', () => {
          return HttpResponse.json(mockHive)
        }),
        http.get('http://localhost:8080/api/v1/hives/:id/members', () => {
          return HttpResponse.json([])
        })
      )

      const {result} = renderHook(
        () => useHiveDetails('456'),
        {wrapper}
      )

      await waitFor(() => {
        expect(result.current.isLoading).toBe(false)
      })

      // Verify authorization check works
      expect(result.current.isOwner).toBe(true)
    })

    it('should return false when current user is not the hive owner', async () => {
      const mockUser: User = {
        id: 'user-123',
        email: 'test@example.com',
        username: 'testuser',
        firstName: 'Test',
        lastName: 'User',
        name: 'Test User',
        isEmailVerified: true,
        createdAt: '2024-01-01T00:00:00Z',
        updatedAt: '2024-01-01T00:00:00Z'
      }

      vi.spyOn(authModule, 'useAuth').mockReturnValue({
        user: mockUser,
        isAuthenticated: true,
        isLoading: false,
        error: null,
        login: vi.fn(),
        logout: vi.fn(),
        register: vi.fn(),
        isLoggingIn: false,
        isLoggingOut: false,
        isRegistering: false,
        loginError: null,
        logoutError: null,
        registerError: null,
        refetchUser: vi.fn(),
        refetchAuthStatus: vi.fn(),
        isUserLoading: false,
        isAuthStatusLoading: false,
        userError: null,
        authStatusError: null
      })

      const mockHive = {
        id: 'hive-456',
        name: 'Test Hive',
        description: 'A test hive',
        ownerId: 'different-user-789', // Different from current user
        memberCount: 5,
        maxMembers: 10,
        isPrivate: false,
        createdAt: '2024-01-01T00:00:00Z'
      }

      vi.mocked(hiveApiService.getHiveById).mockResolvedValue(mockHive)
      vi.mocked(hiveApiService.getHiveMembers).mockResolvedValue([])

      const {result} = renderHook(
        () => useHiveDetails('hive-456'),
        {wrapper}
      )

      await waitFor(() => {
        expect(result.current.isLoading).toBe(false)
      })

      expect(result.current.isOwner).toBe(false)
    })

    it('should return false when user is not authenticated', async () => {
      // Mock unauthenticated state
      vi.spyOn(authModule, 'useAuth').mockReturnValue({
        user: null,
        isAuthenticated: false,
        isLoading: false,
        error: null,
        login: vi.fn(),
        logout: vi.fn(),
        register: vi.fn(),
        isLoggingIn: false,
        isLoggingOut: false,
        isRegistering: false,
        loginError: null,
        logoutError: null,
        registerError: null,
        refetchUser: vi.fn(),
        refetchAuthStatus: vi.fn(),
        isUserLoading: false,
        isAuthStatusLoading: false,
        userError: null,
        authStatusError: null
      })

      const mockHive = {
        id: 'hive-456',
        name: 'Test Hive',
        description: 'A test hive',
        ownerId: 'user-123',
        memberCount: 5,
        maxMembers: 10,
        isPrivate: false,
        createdAt: '2024-01-01T00:00:00Z'
      }

      vi.mocked(hiveApiService.getHiveById).mockResolvedValue(mockHive)
      vi.mocked(hiveApiService.getHiveMembers).mockResolvedValue([])

      const {result} = renderHook(
        () => useHiveDetails('hive-456'),
        {wrapper}
      )

      await waitFor(() => {
        expect(result.current.isLoading).toBe(false)
      })

      expect(result.current.isOwner).toBe(false)
    })
  })

  describe('isMember check', () => {
    it('should return true when current user is in members list (FAILING TEST)', async () => {
      // This test SHOULD FAIL initially to demonstrate the missing functionality
      // After implementation, isMember should be true when current user is in the members list

      const mockUser: User = {
        id: 'user-123',
        email: 'test@example.com',
        username: 'testuser',
        firstName: 'Test',
        lastName: 'User',
        name: 'Test User',
        isEmailVerified: true,
        createdAt: '2024-01-01T00:00:00Z',
        updatedAt: '2024-01-01T00:00:00Z'
      }

      vi.spyOn(authModule, 'useAuth').mockReturnValue({
        user: mockUser,
        isAuthenticated: true,
        isLoading: false,
        error: null,
        login: vi.fn(),
        logout: vi.fn(),
        register: vi.fn(),
        isLoggingIn: false,
        isLoggingOut: false,
        isRegistering: false,
        loginError: null,
        logoutError: null,
        registerError: null,
        refetchUser: vi.fn(),
        refetchAuthStatus: vi.fn(),
        isUserLoading: false,
        isAuthStatusLoading: false,
        userError: null,
        authStatusError: null
      })

      const mockHive = {
        id: 'hive-456',
        name: 'Test Hive',
        description: 'A test hive',
        ownerId: 'different-user',
        memberCount: 3,
        maxMembers: 10,
        isPrivate: false,
        createdAt: '2024-01-01T00:00:00Z'
      }

      const mockMembers = [
        {
          id: 'user-123', // Current user is a member
          username: 'testuser',
          email: 'test@example.com',
          avatar: null
        },
        {
          id: 'user-456',
          username: 'otheruser',
          email: 'other@example.com',
          avatar: null
        }
      ]

      vi.mocked(hiveApiService.getHiveById).mockResolvedValue(mockHive)
      vi.mocked(hiveApiService.getHiveMembers).mockResolvedValue(mockMembers)

      const {result} = renderHook(
        () => useHiveDetails('hive-456'),
        {wrapper}
      )

      await waitFor(() => {
        expect(result.current.isLoading).toBe(false)
      })

      // This assertion should FAIL initially because isMember is hardcoded to false
      // After fix, it should pass
      expect(result.current.isMember).toBe(true)
    })

    it('should return false when current user is not in members list', async () => {
      const mockUser: User = {
        id: 'user-123',
        email: 'test@example.com',
        username: 'testuser',
        firstName: 'Test',
        lastName: 'User',
        name: 'Test User',
        isEmailVerified: true,
        createdAt: '2024-01-01T00:00:00Z',
        updatedAt: '2024-01-01T00:00:00Z'
      }

      vi.spyOn(authModule, 'useAuth').mockReturnValue({
        user: mockUser,
        isAuthenticated: true,
        isLoading: false,
        error: null,
        login: vi.fn(),
        logout: vi.fn(),
        register: vi.fn(),
        isLoggingIn: false,
        isLoggingOut: false,
        isRegistering: false,
        loginError: null,
        logoutError: null,
        registerError: null,
        refetchUser: vi.fn(),
        refetchAuthStatus: vi.fn(),
        isUserLoading: false,
        isAuthStatusLoading: false,
        userError: null,
        authStatusError: null
      })

      const mockHive = {
        id: 'hive-456',
        name: 'Test Hive',
        description: 'A test hive',
        ownerId: 'different-user',
        memberCount: 2,
        maxMembers: 10,
        isPrivate: false,
        createdAt: '2024-01-01T00:00:00Z'
      }

      const mockMembers = [
        {
          id: 'user-456',
          username: 'otheruser',
          email: 'other@example.com',
          avatar: null
        },
        {
          id: 'user-789',
          username: 'anotheruser',
          email: 'another@example.com',
          avatar: null
        }
      ]

      vi.mocked(hiveApiService.getHiveById).mockResolvedValue(mockHive)
      vi.mocked(hiveApiService.getHiveMembers).mockResolvedValue(mockMembers)

      const {result} = renderHook(
        () => useHiveDetails('hive-456'),
        {wrapper}
      )

      await waitFor(() => {
        expect(result.current.isLoading).toBe(false)
      })

      expect(result.current.isMember).toBe(false)
    })

    it('should return false when members list is empty', async () => {
      const mockUser: User = {
        id: 'user-123',
        email: 'test@example.com',
        username: 'testuser',
        firstName: 'Test',
        lastName: 'User',
        name: 'Test User',
        isEmailVerified: true,
        createdAt: '2024-01-01T00:00:00Z',
        updatedAt: '2024-01-01T00:00:00Z'
      }

      vi.spyOn(authModule, 'useAuth').mockReturnValue({
        user: mockUser,
        isAuthenticated: true,
        isLoading: false,
        error: null,
        login: vi.fn(),
        logout: vi.fn(),
        register: vi.fn(),
        isLoggingIn: false,
        isLoggingOut: false,
        isRegistering: false,
        loginError: null,
        logoutError: null,
        registerError: null,
        refetchUser: vi.fn(),
        refetchAuthStatus: vi.fn(),
        isUserLoading: false,
        isAuthStatusLoading: false,
        userError: null,
        authStatusError: null
      })

      const mockHive = {
        id: 'hive-456',
        name: 'Test Hive',
        description: 'A test hive',
        ownerId: 'different-user',
        memberCount: 0,
        maxMembers: 10,
        isPrivate: false,
        createdAt: '2024-01-01T00:00:00Z'
      }

      vi.mocked(hiveApiService.getHiveById).mockResolvedValue(mockHive)
      vi.mocked(hiveApiService.getHiveMembers).mockResolvedValue([])

      const {result} = renderHook(
        () => useHiveDetails('hive-456'),
        {wrapper}
      )

      await waitFor(() => {
        expect(result.current.isLoading).toBe(false)
      })

      expect(result.current.isMember).toBe(false)
    })

    it('should return true when owner is also considered a member', async () => {
      // Owner should also be considered a member
      const mockUser: User = {
        id: 'user-123',
        email: 'test@example.com',
        username: 'testuser',
        firstName: 'Test',
        lastName: 'User',
        name: 'Test User',
        isEmailVerified: true,
        createdAt: '2024-01-01T00:00:00Z',
        updatedAt: '2024-01-01T00:00:00Z'
      }

      vi.spyOn(authModule, 'useAuth').mockReturnValue({
        user: mockUser,
        isAuthenticated: true,
        isLoading: false,
        error: null,
        login: vi.fn(),
        logout: vi.fn(),
        register: vi.fn(),
        isLoggingIn: false,
        isLoggingOut: false,
        isRegistering: false,
        loginError: null,
        logoutError: null,
        registerError: null,
        refetchUser: vi.fn(),
        refetchAuthStatus: vi.fn(),
        isUserLoading: false,
        isAuthStatusLoading: false,
        userError: null,
        authStatusError: null
      })

      const mockHive = {
        id: 'hive-456',
        name: 'Test Hive',
        description: 'A test hive',
        ownerId: 'user-123', // Current user is the owner
        memberCount: 1,
        maxMembers: 10,
        isPrivate: false,
        createdAt: '2024-01-01T00:00:00Z'
      }

      vi.mocked(hiveApiService.getHiveById).mockResolvedValue(mockHive)
      vi.mocked(hiveApiService.getHiveMembers).mockResolvedValue([])

      const {result} = renderHook(
        () => useHiveDetails('hive-456'),
        {wrapper}
      )

      await waitFor(() => {
        expect(result.current.isLoading).toBe(false)
      })

      // Owner should also be considered a member
      expect(result.current.isOwner).toBe(true)
      expect(result.current.isMember).toBe(true) // This will fail initially
    })
  })
})